#!/bin/sh

PKG_DIR="/var/db/pkg"
CACHE_DIR="/var/cache/pkg"

set_executable_permissions() {
    local manifest="$PKG_DIR/$1/manifest"
    
    while read -r file; do
        if [[ "$file" == */bin/* ]] || [[ "$file" == */*.sh ]]; then
            chmod +x "/$file"
            echo "Made executable: /$file"
        fi
    done < "$manifest"
}

install_pkg() {
    local pkg_name="$1"
    local pkg_file="$CACHE_DIR/$pkg_name.tar.xz"
    
    if [ ! -f "$pkg_file" ]; then
        echo "Ошибка: пакет $pkg_name не найден!"
        exit 1
    fi
    
    tar -xJf "$pkg_file" -C /
    
    mkdir -p "$PKG_DIR/$pkg_name"
    tar -tf "$pkg_file" > "$PKG_DIR/$pkg_name/manifest"
    set_executable_permissions "$pkg_name"
    
    echo "Пакет $pkg_name установлен!"
}

remove_pkg() {
    local pkg_name="$1"
    local manifest="$PKG_DIR/$pkg_name/manifest"
    local dirs_to_remove="" 
    
    if [ ! -f "$manifest" ]; then
        echo "Ошибка: пакет $pkg_name не установлен!"
        exit 1
    fi
    
    tac "$manifest" | while read -r file; do
        if [ -f "/$file" ]; then
            rm -v "/$file"
            dirs_to_remove="$dirs_to_remove $(dirname "/$file")"
        elif [ -L "/$file" ]; then
            rm -v "/$file"
        fi
    done
    
    echo "$dirs_to_remove" | tr ' ' '\n' | sort -u | while read -r dir; do
        if [ -d "$dir" ]; then
            rmdir --ignore-fail-on-non-empty -v "$dir"
        fi
    done
    
    rm -rf "$PKG_DIR/$pkg_name"
    
    echo "Пакет $pkg_name удалён!"
}

case "$1" in
    install) install_pkg "$2" ;;
    remove)  remove_pkg "$2"  ;;
    *)       echo "Использование: $0 [install|remove] <пакет>" ;;
esac
